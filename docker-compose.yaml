services:

  # ── DynamoDB Local ────────────────────────────────────────────────────────
  dynamodb:
    image: amazon/dynamodb-local
    container_name: dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── DynamoDB Table Setup (runs once on startup) ────────────────────────────
  dynamodb-setup:
    image: amazon/aws-cli
    depends_on:
      dynamodb:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: fake
      AWS_SECRET_ACCESS_KEY: fake
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      /bin/sh -c "
        echo 'Waiting for DynamoDB...' &&
        sleep 2 &&
        aws dynamodb create-table
          --table-name Deals
          --attribute-definitions
            AttributeName=pk,AttributeType=S
            AttributeName=sk,AttributeType=S
          --key-schema
            AttributeName=pk,KeyType=HASH
            AttributeName=sk,KeyType=RANGE
          --billing-mode PAY_PER_REQUEST
          --endpoint-url http://dynamodb:8000
          --region us-east-1 &&
        echo 'Table created successfully!'
      "
  # ── Lambda (your scraper tools) ───────────────────────────────────────────
  lambda:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: scraper-lambda
    ports:
      - "9000:8080"   # Lambda runtime interface emulator port
    depends_on:
      dynamodb:
        condition: service_healthy
    env_file:
      - .env.local
    environment:
      # Point at the DynamoDB container, not real AWS
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      DEALS_TABLE_NAME: Deals
      IS_LOCAL: "true"
      # Fake credentials so SDK doesn't complain
      AWS_ACCESS_KEY_ID: fake
      AWS_SECRET_ACCESS_KEY: fake
      AWS_DEFAULT_REGION: us-east-1